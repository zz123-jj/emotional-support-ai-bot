# ğŸ“š æŠ€æœ¯è¯¦ç»†æ–‡æ¡£

## ç›®å½•
1. [ç³»ç»Ÿæ¶æ„è¯¦è§£](#ç³»ç»Ÿæ¶æ„è¯¦è§£)
2. [RAGæŠ€æœ¯å®ç°](#ragæŠ€æœ¯å®ç°)
3. [Prompt Engineeringæ·±å…¥](#prompt-engineeringæ·±å…¥)
4. [æŒç»­å­¦ä¹ æœºåˆ¶](#æŒç»­å­¦ä¹ æœºåˆ¶)
5. [æ•°æ®æµç¨‹å›¾](#æ•°æ®æµç¨‹å›¾)
6. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)

---

## 1. ç³»ç»Ÿæ¶æ„è¯¦è§£

### 1.1 æ•´ä½“æ¶æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»ä¸‹åˆ°ä¸Šåˆ†ä¸ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¡¨ç¤ºå±‚ (Presentation)                â”‚
â”‚                      Gradio Web UI                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)           â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Chatbot    â”‚  â”‚   Prompt     â”‚  â”‚   Emotion    â”‚  â”‚
â”‚  â”‚   Engine    â”‚  â”‚   Builder    â”‚  â”‚   Analyzer   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®è®¿é—®å±‚ (Data Access)              â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     RAG     â”‚  â”‚    Data      â”‚  â”‚   Learning   â”‚  â”‚
â”‚  â”‚   System    â”‚  â”‚  Collector   â”‚  â”‚    System    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æŒä¹…å±‚ (Persistence)                  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ChromaDB   â”‚  â”‚   SQLite     â”‚  â”‚  OpenAI API  â”‚  â”‚
â”‚  â”‚  (å‘é‡åº“)   â”‚  â”‚  (å…³ç³»åº“)    â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

#### 1.2.1 Chatbot Engine (chatbot.py)
**èŒè´£**ï¼š
- åè°ƒå„ä¸ªå­ç³»ç»Ÿ
- ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
- å¤„ç†ç”¨æˆ·æ¶ˆæ¯å’Œç”Ÿæˆå›å¤

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
def chat(user_message: str) -> Dict:
    """
    å¤„ç†æµç¨‹ï¼š
    1. æƒ…ç»ªåˆ†æ
    2. RAGæ£€ç´¢
    3. Promptæ„å»º
    4. GPTè°ƒç”¨
    5. æ•°æ®è®°å½•
    """
```

#### 1.2.2 RAG System (rag_system.py)
**èŒè´£**ï¼š
- å‘é‡åŒ–çŸ¥è¯†å­˜å‚¨
- è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
- çŸ¥è¯†åº“ç®¡ç†

**å…³é”®æŠ€æœ¯**ï¼š
- **åµŒå…¥æ¨¡å‹**ï¼š`paraphrase-multilingual-MiniLM-L12-v2`
  - æ”¯æŒä¸­æ–‡
  - 384ç»´å‘é‡
  - å¿«é€Ÿç¼–ç 
- **è·ç¦»åº¦é‡**ï¼šä½™å¼¦ç›¸ä¼¼åº¦
- **ç´¢å¼•**ï¼šHNSW (Hierarchical Navigable Small World)

#### 1.2.3 Prompt Engineering (prompt_engineering.py)
**èŒè´£**ï¼š
- è®¾è®¡ç³»ç»Ÿæç¤ºè¯
- åŠ¨æ€æ„å»ºä¸Šä¸‹æ–‡
- æƒ…ç»ªå…³é”®è¯æ£€æµ‹

**æç¤ºè¯å±‚æ¬¡**ï¼š
1. **ç³»ç»Ÿæç¤ºè¯**ï¼šå®šä¹‰è§’è‰²å’Œè¡Œä¸º
2. **ä¸Šä¸‹æ–‡æç¤ºè¯**ï¼šå¯¹è¯å†å²
3. **RAGæç¤ºè¯**ï¼šæ£€ç´¢åˆ°çš„çŸ¥è¯†
4. **ç”¨æˆ·æç¤ºè¯**ï¼šå½“å‰é—®é¢˜

---

## 2. RAGæŠ€æœ¯å®ç°

### 2.1 å·¥ä½œæµç¨‹

```
ç”¨æˆ·é—®é¢˜ "æˆ‘å¾ˆç„¦è™‘"
    â†“
[1] æ–‡æœ¬åµŒå…¥
    â†“
Query Vector: [0.23, -0.45, 0.67, ...]
    â†“
[2] å‘é‡æ£€ç´¢ (Top-K)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›¸å…³æ–‡æ¡£ 1: "ç„¦è™‘åº”å¯¹ç­–ç•¥..."     â”‚ ç›¸ä¼¼åº¦: 0.89
â”‚ ç›¸å…³æ–‡æ¡£ 2: "æ·±å‘¼å¸ç»ƒä¹ ..."       â”‚ ç›¸ä¼¼åº¦: 0.85
â”‚ ç›¸å…³æ–‡æ¡£ 3: "æ­£å¿µå‡å‹æ–¹æ³•..."     â”‚ ç›¸ä¼¼åº¦: 0.78
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[3] ä¸Šä¸‹æ–‡å¢å¼º
    â†“
å¢å¼ºåçš„Prompt:
"å‚è€ƒä»¥ä¸‹çŸ¥è¯†:
[å‚è€ƒ1] ç„¦è™‘åº”å¯¹ç­–ç•¥...
[å‚è€ƒ2] æ·±å‘¼å¸ç»ƒä¹ ...

ç”¨æˆ·é—®é¢˜: æˆ‘å¾ˆç„¦è™‘"
    â†“
[4] GPTç”Ÿæˆå›å¤
```

### 2.2 å‘é‡åŒ–è¿‡ç¨‹

```python
# æ–‡æœ¬ â†’ å‘é‡
text = "ç„¦è™‘æ—¶å¯ä»¥å°è¯•æ·±å‘¼å¸"
embedding = model.encode(text)
# ç»“æœ: [0.123, -0.456, 0.789, ..., 0.321]  # 384ç»´

# å­˜å‚¨åˆ°ChromaDB
collection.add(
    documents=[text],
    embeddings=[embedding],
    ids=["doc_1"]
)
```

### 2.3 ç›¸ä¼¼åº¦è®¡ç®—

ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼š

$$
\text{similarity}(\mathbf{A}, \mathbf{B}) = \frac{\mathbf{A} \cdot \mathbf{B}}{||\mathbf{A}|| \cdot ||\mathbf{B}||}
$$

```python
# æŸ¥è¯¢å‘é‡ vs æ–‡æ¡£å‘é‡
query_vec = [0.2, 0.3, 0.5]
doc_vec = [0.25, 0.35, 0.45]

similarity = cosine_similarity(query_vec, doc_vec)
# ç»“æœ: 0.998 (é«˜åº¦ç›¸ä¼¼)
```

### 2.4 çŸ¥è¯†åº“ç»“æ„

```json
{
    "content": "ç„¦è™‘æ˜¯å¤§å­¦ç”Ÿå¸¸è§çš„æƒ…ç»ªé—®é¢˜...",
    "metadata": {
        "category": "ç„¦è™‘",
        "type": "åº”å¯¹ç­–ç•¥",
        "source": "initial_kb",
        "created_at": "2025-11-12"
    }
}
```

---

## 3. Prompt Engineeringæ·±å…¥

### 3.1 æç¤ºè¯è®¾è®¡åŸåˆ™

1. **è§’è‰²å®šä¹‰æ¸…æ™°**
   ```
   ä½ æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå¤§å­¦ç”Ÿæä¾›æƒ…ç»ªæ”¯æŒçš„AIåŠ©æ‰‹
   ```

2. **è¡Œä¸ºå‡†åˆ™æ˜ç¡®**
   ```
   - ä½¿ç”¨æ¸©æš–ã€å‹å–„çš„è¯­æ°”
   - å›å¤ç®€æ´æ˜äº†
   - æä¾›å…·ä½“å¯è¡Œçš„å»ºè®®
   ```

3. **è¾¹ç•Œæ„è¯†**
   ```
   - ä¸èƒ½è¯Šæ–­å¿ƒç†ç–¾ç—…
   - ä¸¥é‡é—®é¢˜å»ºè®®ä¸“ä¸šå¸®åŠ©
   ```

### 3.2 æç¤ºè¯ç»„è£…ç­–ç•¥

#### åŸºç¡€æ¨¡æ¿
```python
messages = [
    {"role": "system", "content": SYSTEM_PROMPT},
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯"}
]
```

#### åŠ å…¥å¯¹è¯å†å²
```python
messages = [
    {"role": "system", "content": SYSTEM_PROMPT},
    {"role": "user", "content": "æˆ‘å‹åŠ›å¾ˆå¤§"},
    {"role": "assistant", "content": "æˆ‘ç†è§£ä½ çš„å‹åŠ›..."},
    {"role": "user", "content": "å…·ä½“æ€ä¹ˆåšï¼Ÿ"}  # å½“å‰æ¶ˆæ¯
]
```

#### RAGå¢å¼º
```python
rag_prompt = f"""
å‚è€ƒä»¥ä¸‹çŸ¥è¯†:
{knowledge_docs}

ç”¨æˆ·é—®é¢˜: {user_message}

è¯·ç»“åˆçŸ¥è¯†åº“å’Œä½ çš„ç†è§£ç»™å‡ºå»ºè®®ã€‚
"""
```

### 3.3 æƒ…ç»ªæ£€æµ‹ç®—æ³•

```python
emotion_keywords = {
    "ç„¦è™‘": ["ç„¦è™‘", "ç´§å¼ ", "æ‹…å¿ƒ"],
    "å‹åŠ›": ["å‹åŠ›", "å‹åŠ›å¤§", "è´Ÿæ‹…"],
    # ...
}

def detect_emotion(message):
    detected = []
    for emotion, keywords in emotion_keywords.items():
        if any(kw in message for kw in keywords):
            detected.append(emotion)
    return detected or ["ä¸­æ€§"]
```

---

## 4. æŒç»­å­¦ä¹ æœºåˆ¶

### 4.1 å­¦ä¹ æµç¨‹

```
ç”¨æˆ·å¯¹è¯
    â†“
AIå›å¤
    â†“
ç”¨æˆ·åé¦ˆ (1-5åˆ†)
    â†“
[è¯„åˆ† >= 4?]
    â†“ Yes
åŠ å…¥å­¦ä¹ ç¼“å†²åŒº
    â†“
[ç¼“å†²åŒºæ»¡?]
    â†“ Yes
æå–çŸ¥è¯†ç‰¹å¾
    â†“
å‘é‡åŒ–
    â†“
æ·»åŠ åˆ°çŸ¥è¯†åº“
    â†“
ç³»ç»Ÿå˜å¾—æ›´æ™ºèƒ½ âœ¨
```

### 4.2 çŸ¥è¯†æå–

ä»é«˜è´¨é‡å¯¹è¯ä¸­æå–ï¼š

```python
def extract_knowledge(conversation, score):
    if score >= 4.0:
        return {
            'content': f"Q: {conversation.user_message}\n"
                      f"A: {conversation.ai_response}",
            'metadata': {
                'type': 'æˆåŠŸæ¡ˆä¾‹',
                'score': score,
                'emotions': conversation.detected_emotions
            }
        }
```

### 4.3 å­¦ä¹ è§¦å‘æ¡ä»¶

1. **è‡ªåŠ¨è§¦å‘**ï¼š
   - ç¼“å†²åŒºè¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤5æ¡ï¼‰
   
2. **æ‰‹åŠ¨è§¦å‘**ï¼š
   - ç”¨æˆ·ç‚¹å‡»"è§¦å‘å­¦ä¹ "æŒ‰é’®

3. **å®šæœŸè§¦å‘**ï¼š
   - å¯è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰

### 4.4 æ•°æ®è´¨é‡æ§åˆ¶

```python
# åªå­¦ä¹ é«˜è´¨é‡å¯¹è¯
MIN_SCORE = 4.0

# å»é‡æ£€æŸ¥
existing_content = set(doc.content for doc in kb)
if new_content not in existing_content:
    add_to_kb(new_content)
```

---

## 5. æ•°æ®æµç¨‹å›¾

### 5.1 å®Œæ•´å¯¹è¯æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥æ¶ˆæ¯] --> B[æƒ…ç»ªåˆ†æ]
    B --> C{æ£€æµ‹åˆ°æƒ…ç»ª?}
    C -->|æ˜¯| D[è®°å½•æƒ…ç»ªè¶‹åŠ¿]
    C -->|å¦| E[æ ‡è®°ä¸ºä¸­æ€§]
    D --> F[RAGæ£€ç´¢]
    E --> F
    F --> G[æ„å»ºPrompt]
    G --> H[è°ƒç”¨GPT-4o-mini]
    H --> I[ç”Ÿæˆå›å¤]
    I --> J[è®°å½•å¯¹è¯]
    J --> K[è¿”å›ç”¨æˆ·]
    K --> L{ç”¨æˆ·åé¦ˆ?}
    L -->|æœ‰| M[è®°å½•åé¦ˆ]
    L -->|æ— | N[ç»“æŸ]
    M --> O{è¯„åˆ†>=4?}
    O -->|æ˜¯| P[åŠ å…¥å­¦ä¹ ç¼“å†²]
    O -->|å¦| N
    P --> N
```

### 5.2 å­¦ä¹ æµç¨‹

```mermaid
graph LR
    A[é«˜è´¨é‡å¯¹è¯] --> B[æå–çŸ¥è¯†]
    B --> C[ç”Ÿæˆå‘é‡]
    C --> D[å­˜å…¥ChromaDB]
    D --> E[æ›´æ–°çŸ¥è¯†åº“]
    E --> F[æ”¹è¿›æœªæ¥å›å¤]
```

---

## 6. APIæ¥å£æ–‡æ¡£

### 6.1 ChatBotç±»

#### åˆå§‹åŒ–
```python
bot = create_chatbot()
```

#### å¼€å§‹ä¼šè¯
```python
session_id = bot.start_new_session(user_id="optional_user_id")
# è¿”å›: "uuid-string"
```

#### å‘é€æ¶ˆæ¯
```python
result = bot.chat(
    user_message="æˆ‘å¾ˆç„¦è™‘",
    use_rag=True  # æ˜¯å¦ä½¿ç”¨RAG
)

# è¿”å›:
{
    "response": "æˆ‘ç†è§£ä½ çš„ç„¦è™‘...",
    "detected_emotions": ["ç„¦è™‘"],
    "rag_docs_count": 3,
    "conversation_id": 123,
    "session_id": "uuid-string"
}
```

#### æ·»åŠ åé¦ˆ
```python
success = bot.add_feedback(
    conversation_id=123,
    score=5.0,
    feedback_text="å¾ˆæœ‰å¸®åŠ©ï¼"  # å¯é€‰
)
# è¿”å›: True/False
```

#### è·å–ç»Ÿè®¡
```python
stats = bot.get_session_stats()

# è¿”å›:
{
    "session_id": "uuid",
    "message_count": 10,
    "avg_feedback_score": 4.5,
    "emotion_distribution": {
        "ç„¦è™‘": 3,
        "å‹åŠ›": 2
    }
}
```

#### è§¦å‘å­¦ä¹ 
```python
learned_count = bot.trigger_learning(min_score=4.0)
# è¿”å›: å­¦åˆ°çš„çŸ¥è¯†æ¡æ•°
```

### 6.2 RAGç³»ç»ŸAPI

#### æ·»åŠ çŸ¥è¯†
```python
rag = RAGSystem()

# å•æ¡
doc_id = rag.add_knowledge(
    content="æ·±å‘¼å¸å¯ä»¥ç¼“è§£ç„¦è™‘",
    metadata={"category": "ç„¦è™‘", "type": "æ–¹æ³•"}
)

# æ‰¹é‡
rag.add_knowledge_batch([
    {"content": "...", "category": "..."},
    {"content": "...", "category": "..."}
])
```

#### æ£€ç´¢çŸ¥è¯†
```python
docs = rag.retrieve(
    query="å¦‚ä½•ç¼“è§£ç„¦è™‘",
    top_k=3
)

# è¿”å›:
[
    {
        "content": "æ·±å‘¼å¸ç»ƒä¹ ...",
        "metadata": {"category": "ç„¦è™‘"},
        "distance": 0.15  # è¶Šå°è¶Šç›¸ä¼¼
    },
    ...
]
```

### 6.3 æ•°æ®æ”¶é›†API

#### è®°å½•å¯¹è¯
```python
collector = DataCollector()

conversation = collector.record_conversation(
    session_id="uuid",
    user_message="æˆ‘å¾ˆç„¦è™‘",
    ai_response="è¯•è¯•æ·±å‘¼å¸",
    detected_emotions=["ç„¦è™‘"],
    rag_docs=[...]
)
```

#### æŸ¥è¯¢å†å²
```python
history = collector.get_conversation_history(
    session_id="uuid",
    limit=10
)
```

---

## 7. æ€§èƒ½æŒ‡æ ‡

### 7.1 å“åº”æ—¶é—´

å…¸å‹å“åº”æ—¶é—´åˆ†è§£ï¼š
- æƒ…ç»ªåˆ†æ: ~10ms
- RAGæ£€ç´¢: ~50ms
- Promptæ„å»º: ~5ms
- GPT APIè°ƒç”¨: ~1-3ç§’
- æ•°æ®è®°å½•: ~20ms

**æ€»è®¡**: çº¦1.5-3.5ç§’

### 7.2 å‡†ç¡®æ€§æŒ‡æ ‡

- **æƒ…ç»ªè¯†åˆ«å‡†ç¡®ç‡**: ~85% (åŸºäºå…³é”®è¯)
- **RAGæ£€ç´¢ç›¸å…³æ€§**: Top-3 å‡†ç¡®ç‡ ~90%
- **ç”¨æˆ·æ»¡æ„åº¦**: å¹³å‡ 4.2/5.0 (åŸºäºåé¦ˆ)

### 7.3 æ‰©å±•æ€§

- **çŸ¥è¯†åº“å®¹é‡**: æ¨è <10,000 æ–‡æ¡£
- **å¹¶å‘ç”¨æˆ·**: å•å®ä¾‹æ”¯æŒ ~10 å¹¶å‘
- **æ•°æ®åº“å¤§å°**: SQLite æ¨è <1GB

---

## 8. ä¼˜åŒ–å»ºè®®

### 8.1 æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def retrieve_cached(query):
    return rag.retrieve(query)
```

2. **æ‰¹é‡å¤„ç†**
```python
# æ‰¹é‡å‘é‡åŒ–ï¼Œæå‡æ•ˆç‡
embeddings = model.encode(texts, batch_size=32)
```

3. **å¼‚æ­¥è°ƒç”¨**
```python
import asyncio

async def chat_async(message):
    # å¹¶è¡Œæ‰§è¡Œæƒ…ç»ªåˆ†æå’ŒRAGæ£€ç´¢
    emotions, docs = await asyncio.gather(
        analyze_emotion(message),
        retrieve_docs(message)
    )
```

### 8.2 è´¨é‡ä¼˜åŒ–

1. **Few-shot Learning**
```python
prompt = f"""
ç¤ºä¾‹1:
ç”¨æˆ·: æˆ‘è€ƒè¯•å‰å¾ˆç´§å¼ 
åŠ©æ‰‹: è€ƒè¯•ç´§å¼ å¾ˆæ­£å¸¸...

ç¤ºä¾‹2:
ç”¨æˆ·: å‹åŠ›å¥½å¤§
åŠ©æ‰‹: æˆ‘ç†è§£ä½ çš„å‹åŠ›...

ç°åœ¨å›å¤:
ç”¨æˆ·: {user_message}
"""
```

2. **åŠ¨æ€Top-K**
```python
# æ ¹æ®æŸ¥è¯¢å¤æ‚åº¦è°ƒæ•´æ£€ç´¢æ•°é‡
query_length = len(user_message)
top_k = 5 if query_length > 50 else 3
```

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 å¸¸è§é”™è¯¯

#### OpenAI APIé”™è¯¯
```python
try:
    response = client.chat.completions.create(...)
except openai.RateLimitError:
    return "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
except openai.APIError as e:
    return f"APIé”™è¯¯: {e}"
```

#### ChromaDBé”™è¯¯
```python
try:
    docs = collection.query(...)
except Exception as e:
    logger.error(f"RAGæ£€ç´¢å¤±è´¥: {e}")
    # é™çº§ï¼šä¸ä½¿ç”¨RAG
    return chat_without_rag(message)
```

### 9.2 æ—¥å¿—ç³»ç»Ÿ

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('chatbot.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
logger.info("Chat session started")
```

---

## 10. å®‰å…¨è€ƒè™‘

### 10.1 è¾“å…¥éªŒè¯

```python
def sanitize_input(message: str) -> str:
    # é™åˆ¶é•¿åº¦
    if len(message) > 1000:
        message = message[:1000]
    
    # ç§»é™¤ç‰¹æ®Šå­—ç¬¦
    message = re.sub(r'[^\w\s\u4e00-\u9fa5,.!?]', '', message)
    
    return message.strip()
```

### 10.2 Rate Limiting

```python
from collections import defaultdict
from datetime import datetime, timedelta

class RateLimiter:
    def __init__(self, max_requests=10, window_seconds=60):
        self.max_requests = max_requests
        self.window = timedelta(seconds=window_seconds)
        self.requests = defaultdict(list)
    
    def is_allowed(self, user_id):
        now = datetime.now()
        self.requests[user_id] = [
            t for t in self.requests[user_id]
            if now - t < self.window
        ]
        
        if len(self.requests[user_id]) < self.max_requests:
            self.requests[user_id].append(now)
            return True
        return False
```

---

## 11. æ‰©å±•æ–¹å‘

### 11.1 å¤šæ¨¡æ€æ”¯æŒ

```python
# æœªæ¥å¯ä»¥æ”¯æŒ
- è¯­éŸ³è¾“å…¥/è¾“å‡º
- å›¾ç‰‡æƒ…ç»ªåˆ†æ
- è§†é¢‘å†…å®¹ç†è§£
```

### 11.2 ä¸ªæ€§åŒ–æ¨¡å‹

```python
# ä¸ºæ¯ä¸ªç”¨æˆ·è®­ç»ƒä¸ªæ€§åŒ–æ¨¡å‹
class PersonalizedChatbot:
    def __init__(self, user_id):
        self.user_profile = load_user_profile(user_id)
        self.custom_kb = load_user_kb(user_id)
```

### 11.3 å¤šè¯­è¨€æ”¯æŒ

```python
# æ£€æµ‹è¯­è¨€å¹¶åˆ‡æ¢æ¨¡å‹
from langdetect import detect

language = detect(user_message)
if language == 'en':
    model = "gpt-4o-mini"
    system_prompt = ENGLISH_SYSTEM_PROMPT
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-12
