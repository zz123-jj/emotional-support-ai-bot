# 系统架构可视化

## 整体架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                          用户层                                     │
│                     (User Interface)                               │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │              Gradio Web Interface                        │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │     │
│  │  │ 聊天标签  │  │ 统计标签  │  │ 学习标签  │  │ 帮助标签 │ │     │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │     │
│  └──────────────────────────────────────────────────────────┘     │
└─────────────────────────┬──────────────────────────────────────────┘
                          │ HTTP/WebSocket
                          ▼
┌────────────────────────────────────────────────────────────────────┐
│                        应用逻辑层                                   │
│                   (Application Logic)                              │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │           EmotionalSupportChatbot (chatbot.py)               │ │
│  │                     核心协调引擎                              │ │
│  └───────┬──────────────┬──────────────┬──────────────┬─────────┘ │
│          │              │              │              │           │
│  ┌───────▼────┐ ┌───────▼─────┐ ┌─────▼─────┐ ┌─────▼──────┐   │
│  │  Prompt    │ │     RAG     │ │   Data    │ │  Emotion   │   │
│  │  Builder   │ │   System    │ │ Collector │ │  Analyzer  │   │
│  │            │ │             │ │           │ │            │   │
│  │ • 构建提示  │ │ • 知识检索   │ │ • 记录对话 │ │ • 情绪识别  │   │
│  │ • 上下文整合│ │ • 向量搜索   │ │ • 反馈收集 │ │ • 关键词检测│   │
│  └────────────┘ └─────────────┘ │ • 统计分析 │ └────────────┘   │
│                                  │ • 持续学习 │                  │
│                                  └────────────┘                  │
└─────────────────────────┬──────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────────┐
│                       数据存储层                                    │
│                    (Data Storage)                                  │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐    │
│  │  ChromaDB    │  │   SQLite     │  │    OpenAI API        │    │
│  │  向量数据库   │  │  关系数据库   │  │   GPT-4o-mini       │    │
│  │              │  │              │  │                      │    │
│  │ • 知识向量    │  │ • 对话历史    │  │ • 文本生成          │    │
│  │ • 语义检索    │  │ • 用户会话    │  │ • 自然语言理解      │    │
│  │ • 持久化存储  │  │ • 反馈评分    │  │                      │    │
│  │              │  │ • 情绪趋势    │  │                      │    │
│  └──────────────┘  └──────────────┘  └──────────────────────┘    │
└────────────────────────────────────────────────────────────────────┘
```

## 数据流程图

```
用户输入 "我很焦虑"
    │
    ▼
┌─────────────────┐
│  情绪分析模块    │ → 检测: ["焦虑"]
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   RAG检索系统   │ → 查询知识库
└────────┬────────┘
         │
         ├─→ 向量化: [0.23, -0.45, ...]
         │
         ├─→ 相似度搜索 (ChromaDB)
         │
         └─→ 返回Top-3文档:
              • "焦虑应对策略" (0.89)
              • "深呼吸练习" (0.85)
              • "正念技巧" (0.78)
         │
         ▼
┌─────────────────┐
│ Prompt构建器    │
└────────┬────────┘
         │
         ├─→ 系统提示词
         ├─→ 对话历史
         ├─→ RAG检索结果
         └─→ 用户问题
         │
         ▼
┌─────────────────┐
│  OpenAI API     │ → GPT-4o-mini
└────────┬────────┘
         │
         ▼
AI回复: "我理解你的焦虑..."
         │
         ▼
┌─────────────────┐
│  数据收集器      │
└────────┬────────┘
         │
         ├─→ 记录对话 (SQLite)
         ├─→ 记录情绪趋势
         └─→ 等待用户反馈
         │
         ▼
用户反馈: 5.0/5.0
         │
         ▼
┌─────────────────┐
│  学习系统       │ → 加入学习缓冲
└────────┬────────┘
         │
         ▼
    知识库更新
```

## RAG系统详细架构

```
┌─────────────────────────────────────────────────┐
│              RAG System Architecture            │
└─────────────────────────────────────────────────┘

   知识库文档
        │
        ▼
┌──────────────────┐
│  文本分块        │ (RecursiveCharacterTextSplitter)
│  Chunk Size: 500 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  向量嵌入        │ (Sentence Transformers)
│  Model: MiniLM  │
│  Dimension: 384 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  ChromaDB存储    │
│  • HNSW索引     │
│  • 余弦相似度    │
└────────┬─────────┘
         │
         │        用户查询 "如何缓解焦虑？"
         │              │
         ▼              ▼
    ┌────────────────────────────┐
    │       查询向量化            │
    └──────────┬─────────────────┘
               │
               ▼
    ┌────────────────────────────┐
    │    向量相似度搜索           │
    │    返回Top-K (默认3)       │
    └──────────┬─────────────────┘
               │
               ▼
    ┌────────────────────────────┐
    │    相关文档 + 元数据        │
    │    + 相似度分数            │
    └────────────────────────────┘
```

## Prompt Engineering流程

```
┌─────────────────────────────────────────────────┐
│         Prompt Engineering Pipeline             │
└─────────────────────────────────────────────────┘

系统提示词 (System Prompt)
    ↓
    "你是专门为大学生提供情绪支持的AI助手..."
    • 定义角色
    • 设置行为准则
    • 明确边界
    
    +
    
对话历史 (Conversation History)
    ↓
    [
        {"role": "user", "content": "我压力很大"},
        {"role": "assistant", "content": "我理解..."},
        ...
    ]
    • 保持上下文连贯
    • 限制历史长度 (10条)
    
    +
    
RAG增强内容 (Knowledge Context)
    ↓
    "参考以下知识库内容:
    [参考1] (焦虑) 深呼吸可以缓解焦虑...
    [参考2] (压力) 番茄工作法提高效率...
    [参考3] (放松) 正念练习减压..."
    
    +
    
当前用户问题 (Current Query)
    ↓
    "我很焦虑，怎么办？"
    
    ║
    ▼
    
完整Prompt发送给GPT-4o-mini
    ↓
生成温暖、专业、实用的回复
```

## 持续学习机制

```
┌─────────────────────────────────────────────┐
│         Continuous Learning System          │
└─────────────────────────────────────────────┘

对话发生
    ↓
AI回复
    ↓
用户反馈评分 (1-5)
    │
    ├─→ 分数 < 4 → 忽略
    │
    └─→ 分数 ≥ 4 → 进入学习流程
                     ↓
            ┌────────────────────┐
            │  提取有价值知识     │
            │  • 用户问题        │
            │  • AI回复          │
            │  • 情绪标签        │
            │  • 评分           │
            └─────────┬──────────┘
                      │
                      ▼
            ┌────────────────────┐
            │  加入学习缓冲区     │
            │  缓冲区大小: 5     │
            └─────────┬──────────┘
                      │
                      ▼
                 缓冲区满？
                      │
                   是 │
                      ▼
            ┌────────────────────┐
            │  批量向量化        │
            │  添加到知识库      │
            └─────────┬──────────┘
                      │
                      ▼
            知识库自动扩充
                      │
                      ▼
            未来回复质量提升 ✨
```

## 数据库Schema

```
┌─────────────────────────────────────────────┐
│            SQLite Database Schema           │
└─────────────────────────────────────────────┘

┌──────────────────────┐
│   conversations      │
├──────────────────────┤
│ id (PK)             │
│ session_id          │ ────┐
│ user_id             │     │
│ timestamp           │     │
│ user_message        │     │
│ ai_response         │     │
│ detected_emotions   │     │
│ rag_docs_used       │     │
│ feedback_score      │     │
│ feedback_text       │     │
└──────────────────────┘     │
                             │
                             │
┌──────────────────────┐     │
│   user_sessions      │     │
├──────────────────────┤     │
│ id (PK)             │     │
│ session_id (UNIQUE) │ ◄───┘
│ user_id             │
│ start_time          │
│ last_active         │
│ message_count       │
│ avg_feedback_score  │
└──────────────────────┘
         │
         │
         └──────────────┐
                        │
┌──────────────────────┐│
│   emotion_trends     ││
├──────────────────────┤│
│ id (PK)             ││
│ session_id          │◄
│ timestamp           │
│ emotion             │
│ intensity           │
└──────────────────────┘
```

## 技术栈总览

```
┌─────────────────────────────────────────────┐
│              Technology Stack               │
└─────────────────────────────────────────────┘

前端界面:
    └─ Gradio 4.16.0
         • Web UI框架
         • 实时交互
         • 多标签页支持

后端核心:
    └─ Python 3.8+
         ├─ OpenAI SDK → GPT-4o-mini调用
         ├─ LangChain → RAG框架
         ├─ Sentence Transformers → 文本嵌入
         └─ SQLAlchemy → ORM数据库操作

向量存储:
    └─ ChromaDB 0.4.22
         • 嵌入向量存储
         • HNSW索引
         • 持久化到磁盘

关系数据库:
    └─ SQLite
         • 轻量级
         • 无需配置
         • 本地存储

AI模型:
    └─ GPT-4o-mini (OpenAI)
         • 成本优化
         • 快速响应
         • 高质量生成

    └─ paraphrase-multilingual-MiniLM-L12-v2
         • 多语言支持
         • 384维向量
         • 高效编码
```

---

**这些可视化图表展示了系统的完整架构和数据流程**
